name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]

permissions:
  pull-requests: write
  contents: read
  id-token: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    if: github.event_name == "pull_request"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get diff files
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E "\.(py|yaml|yml|toml)$" || echo "")
          echo "files=$FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $FILES"

      - name: Collect code changes
        id: changes
        if: steps.diff.outputs.files != ""
        run: |
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          for file in $(echo "${{ steps.diff.outputs.files }}" | tr " " "\n"); do
            echo "## $file" >> $GITHUB_OUTPUT
            echo '```diff' >> $GITHUB_OUTPUT
            git diff origin/${{ github.base_ref }}...HEAD -- "$file" >> $GITHUB_OUTPUT || true
            echo '```' >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
          done
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Claude Review
        uses: anthropic-actions/claude-review@v0.3.0
        if: steps.diff.outputs.files != ""
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          diff: ${{ steps.changes.outputs.changes }}
          prompt: |
            Review these changes focusing on: security, bugs, type safety, code smell, and best practices.
            Be concise. Use bullet points with severity prefixes.
